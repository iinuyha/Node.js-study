# [2장] MySQL
## 2.2. 실습 준비
### 1)  콘솔 진입 방법
- `C:\Program Files\MySQL\MySQL Server 8.0\bin`에서 터미널에 아래 코드 입력하기
    ```bash
    mysql -uroot -p
    ```
- `C:\ProgramData\Microsoft\Windows\Start Menu\Programs\MySQL\MySQL Server 8.0` 위치에 있는 **'MySQL 8.0 Command Line Client'** 실행시키기
➡️ 두번째 이용함
### 2) DB 생성하기
1. `opentutorials` DB 생성
    ```sql
    CREATE DATABASE opentutorials;
    ```
2. `author` 테이블 스키마 생성
    ```sql
    CREATE TABLE `author` (
        `id` int(11) NOT NULL AUTO_INCREMENT,
        `name` varchar(20) NOT NULL,
        `profile` varchar(200) DEFAULT NULL,
        PRIMARY KEY (`id`)
    );
    ```
3. `author` 테이블에 데이터 삽입
    ```sql
    INSERT INTO `author` VALUES (1,'egoing','developer');
    INSERT INTO `author` VALUES (2,'duru','database administrator');
    INSERT INTO `author` VALUES (3,'taeho','data scientist, developer');
    ```
4. `topic` 테이블 스키마 생성
    ```sql
    CREATE TABLE `topic` (
        `id` int(11) NOT NULL AUTO_INCREMENT,
        `title` varchar(30) NOT NULL,
        `description` text,
        `created` datetime NOT NULL,
        `author_id` int(11) DEFAULT NULL,
        PRIMARY KEY (`id`)
    );
    ```
5. `topic` 테이블에 데이터 삽입
    ```sql
    INSERT INTO `topic` VALUES (1,'MySQL','MySQL is...','2018-01-01 12:10:11',1);
    INSERT INTO `topic` VALUES (2,'Oracle','Oracle is ...','2018-01-03 13:01:10',1);
    INSERT INTO `topic` VALUES (3,'SQL Server','SQL Server is ...','2018-01-20 11:01:10',2);
    INSERT INTO `topic` VALUES (4,'PostgreSQL','PostgreSQL is ...','2018-01-23 01:03:03',3);
    INSERT INTO `topic` VALUES (5,'MongoDB','MongoDB is ...','2018-01-30 12:31:03',1);
    ```
### 3) Node.js에서 외부 라이브러리를 사용하기 위한 설정
1. `package.json` 파일에서 의존성 설정
    - `dependencies`: 사용하는 외부 라이브러리
    ```json
    "dependencies": {
        "sanitize-html": "^1.18.2"
    }
    ```
2. `npm install`을 하여 `node_modules` 디렉터리 생성 확인
    - 디렉터리 안에 원하는 모듈이 있는지 체크하기

## 2.3. mysql 모듈의 기본 사용법
### 1) mysql 모듈 설치 연동하기
1. 터미널에 `npm install --save mysql` 입력
2. `package.json` 파일의 `dependencies`에 mysql이 모듈이 추가되었는지 확인
3. `nodejs/mysql.js` 생성
    ```javascript
    var mysql = require('mysql');   // mysql 모듈 불러오기
    
    // 연결정보 입력
    var connection = mysql.createConnection({
        host     : 'localhost', // DB가 있는 서버 주소
        user     : 'nodejs',    // 사용자 이름
        password : '0731',    // 비밀번호
        database : 'opentutorials'  // 접속할 DB의 이름
    });

    connection.connect();   // DB에 접속

    // DB에 질의문 전달
    connection.query('SELECT * from topic', function (error, results, fields) {
        if (error) {
            console.log(error);
        }
        console.log(results);
    });

    connection.end();   // 접속 종료
    ```
    - mysql 모듈 불러오기 (`require('mysql')`)
    - 연결정보 입력 (`mysql.createConnection`)
    - DB 연결 (`connection.connect()`)
    - DB에 질의문 전달 (`connection.query(질의문)`)
    - DB 접속 종료 (`connection.end()`)

> ⭐ 연동 시 발생하는 에러 해결 방법: [velog.io/@nuyhanos](https://velog.io/@nuyhanos/MySQL-8.0-Nodejs-%EC%97%B0%EB%8F%99-%EC%8B%9C-%EC%97%90%EB%9F%AC-Client-does-not-support)


## 2.4. mysql 모듈을 이용한 홈페이지 구현
### 1) DB 연결
```javascript
var mysql = require('mysql');   // sql 모듈 불러오기
// mysql 커넥션 선언
var db = mysql.createConnection({
    host     : 'localhost',
    user     : 'root',
    password : '0731',
    database : 'opentutorials'
});
db.connect();   // mysql 연결
...
```
### 2) DB에 질의문 전달
➡️ 기존에 파일에서 데이터를 불러오는 부분을 DB에서 읽어오게 수정
```javascript
...
if(pathname === '/') {
    if(queryData.id === undefined) {
        db.query(`SELECT * FROM topic`, function(err, topics) {
            console.log(topics);
            response.writeHead(200);
            response.end('Success');
    });
} else
...
```

### 3) DB에 저장된 데이터로 웹 페이지 생성
```javascript
if(queryData.id === undefined) {
    db.query(`SELECT * FROM topic`, function(error, topics) {
        var title = 'Welcome';
        var description = 'Hello, Node.js';
        var list = template.list(topics);   // topics 자체를 전달
        var html = template.HTML(title, list,
                `<h2>${title}</h2>${description}`,
                `<a href="/create">create</a>`
        );
        response.writeHead(200);
        response.end(html);
    });
} else
```

### 4) `template.js`에서 list 메서드의 매개변수 이름 변경
```javascript
list:function(topics) {
    var list = '<ul>';
    var i = 0;
    while(i < topics.length) {
        // id와 title 프로퍼티를 지정해줌
        list = list + `<li><a href="/?id=${topics[i].id}">${topics[i].title}</a></li>`;
        i = i + 1;
    }
    list = list+'</ul>';
    return list;
}
```
- filelist에서 topics로 변경
- topics는 **_객체 형태_**이기 때문에 id와 title 프로퍼티를 지정해줘야 함


## 2.5. mysql로 상세 보기 페이지 구현
### 1) 전체 글 목록 가져오기
```javascript
...
if(queryData.id === undefined) {
    ...
} else {
    db.query(`SELECT * FROM topic`, function(error, topics) {
        var title = 'Welcome';
        var description = 'Hello, Node.js';
        var list = template.list(topics);
        var html = template.HTML(title, list,
            `<h2>${title}</h2>${description}`,
            `<a href="/create">create</a>`
        );
        response.writeHead(200);
        response.end(html);
    });
}
...
```
- 기존에 파일에서 글 목록을 불러오는 부분을 DB에서 가져오도록 변경
- id 쿼리스크링은 `topic` 테이블의 `id` 컬럼에 해당
### 2) 특정 글을 선택했을 때 해당 글의 정보 가져오기
```javascript
...
if(queryData.id === undefined) {
    ...
} else {
    db.query(`SELECT * FROM topic`, function(error, topics) {
        db.query(`SELECT * FROM topic WHERE id=${queryData.id}`, function(error2, topic) {
            var title = 'Welcome';
            var description = 'Hello, Node.js';
            var list = template.list(topics);
            var html = template.HTML(title, list,
                `<h2>${title}</h2>${description}`,
                `<a href="/create">create</a>`
            );
            response.writeHead(200);
            response.end(html);
        }
    });
}
...
```
- `topic` 테이블에서 모든 행을 불러오고, id가 `queryData.id`인 행을 불러오기

### 3) 에러 처리하는 코드 추가
```javascript
db.query(`SELECT * FROM topic`, function(error, topics) {
    if(error) {
        throw error;
    }
    db.query(`SELECT * FROM topic WHERE id=${queryData.id}`, function(error2, topic) {
        if(error2) {
            throw error2;
        }
        var title = 'Welcome';
        var description = 'Hello, Node.js';
        var list = template.list(topics);
        var html = template.HTML(title, list,
            `<h2>${title}</h2>${description}`,
            ` <a href="/create">create</a>`
        );
        response.writeHead(200);
        response.end(html);
    });
});
```
### 4) 페이지별 타이틀 추가
```javascript
db.query(`SELECT * FROM topic WHERE id=${queryData.id}`, function(error2, topic) {
    if(error2) {
        throw error2;
    }
    var title = topic[0].title; // 타이틀을 topic 테이블의 title 컬럼으로
    var description = topic[0].description; // 설명을 topic 테이블의 description 컬럼으로
    var list = template.list(topics);
    var html = template.HTML(title, list,
                        `<h2>${title}</h2>${description}`,
                        ` <a href="/create">create</a>`
    );
    response.writeHead(200);
    response.end(html);
});
```
### 5) id를 직접적으로 전달하지 않도록 보안 강화
```javascript
db.query(`SELECT * FROM topic WHERE id=?`, [queryData.id], function(error2, topic) {}
```
- `id=?`에서 `?`는 **플레이스홀더**라고 함
    - **플레이스홀더**: SQL 쿼리에서 사용되는 특별한 기호로, 실행될 때 값이 대체되는 자리 표시자
- `[queryData.id]`: 플레이스홀더 자리에 대체될 값을 제공하는 배열

> ⭐ JavaScript에서 모듈을 export하는 방법 [velog.io/@nuyhanos](https://velog.io/@nuyhanos/JavaScript%EC%97%90%EC%84%9C-%EB%AA%A8%EB%93%88%EC%9D%84-export%ED%95%98%EB%8A%94-%EB%B0%A9%EB%B2%95)
### 6) 상세 페이지에 글 수정, 삭제 링크와 버튼 추가
```javascript
else{
    ...
    var html = template.HTML(title, list,
        `<h2>${title}</h2>${description}`,
        ` <a href="/create">create</a>
            <a href="/update?id=${queryData.id}">update</a>
            <form action="delete_process" method="post">
                <input type="hidden" name="id" value="${queryData.id}">
                <input type="submit" value="delete">
            </form>`
    );
}
```
## 2.6. mysql을 이용한 글 생성 기능 구현
➡️ DB에 직접 데이터를 추가하는 방식이 아닌, 사용자가 온라인에서 데이터를 삽입하는 방법
### 1) 글 생성 페이지에서 글 목록이 나오도록
```javascript
else if(pathname === '/create') {
    db.query(`SELECT * FROM topic`, function(error, topics) {
        var title = 'Create';
        var list = template.list(topics);
        var html = template.HTML(title, list,
            `
            <form action="/create_process" method="post">
                <p><input type="text" name="title" placeholder="title"></p>
                <p>
                    <textarea name="description" placeholder="description"></textarea>
                </p>
                <p>
                    <input type="submit">
                </p>
            </form>
            `,
            `<a href="/create">create</a>`
        );
        response.writeHead(200);
        response.end(html);
    });
}
```
### 2) submit 버튼을 누르면 정보가 DB에 저장되도록 `create_process` 수정
```javascript
request.on('end', function() {
    var post = qs.parse(body);
    db.query(`
        INSERT INTO topic (title, description, created, author_id)
            VALUES(?, ?, NOW(), ?)`,
        [post.title, post.description, 1], function(error, result) {
            if(error) {
                throw error;
            }
            response.writeHead(302, {Location: `/?id=${result.insertId}`}); //새로 추가한 데이터의 id값을 DB에서 가져오기
            response.end();
        }
    );
});
```
- 테이블에 데이터를 추가할 때 `INSERT INTO 테이블명 (컬럼명) VALUES (데이터)` 사용
- `INSERT INTO topic (title, description, created, author_id) VALUES(?, ?, NOW(), ?), [post.title, post.description, 1]`: 물음표 이용하여 안전하게 처리
    - 첫 번째 물음표: 제목
    - 두 번째 물음표: 내용
    - 세 번째 물음표: 작성자 (나중에 구현할거니까 일단 임시로 1로 지정)

## 2.7. mysql로 글 수정 기능 구현
### 1) update를 클릭했을 때 보이는 화면(`/update`)
```javascript
else if(pathname === '/update') {
    db.query('SELECT * FROM topic', function(error, topics) {
        if(error) {
            throw error;
        }
        db.query(`SELECT * FROM topic WHERE id=?`,[queryData.id], function(error2, topic) {
            if(error2) {
                throw error2;
            }

            var list = template.list(topics);
            var html = template.HTML(topic[0].title, list,
                `
                <form action="/update_process" method="post">
                    <input type="hidden" name="id" value="${topic[0].id}">
                    <p><input type="text" name="title" placeholder="title" value="${topic[0].title}"></p>
                    <p>
                        <textarea name="description" placeholder="description">${topic[0].description}</textarea>
                    </p>
                    <p>
                        <input type="submit">
                    </p>
                </form>
                `,
                `<a href="/create">create</a> <a href="update?id=${topic[0].id}">update</a>`
            );
            response.writeHead(200);
            response.end(html);
        });
    });
}
```
- filelist를 topics로, title을 topic[0].title로
- id를 topic[0].id로
- 제목과 내용을 각각 topic[0].title, topic[0].description으로
### 2) 글 수정 기능(`/update_process` 페이지) 수정
```javascript
request.on('end', function() {
    var post = qs.parse(body);
    db.query('UPDATE topic SET title=?, description=?, author_id=1 WHERE id=?',
        [post.title, post.description, post.id], function(error, result) {
        response.writeHead(302, {Location: `/?id=${post.id}`});
        response.end();
    });
});
```
- mysql의 `UPDATE` 질의문을 통해서 데이터 수정 기능 구현

## 2.8. mysql로 글 삭제 기능 구현
### 1) delete_process 페이지 수정
```javascript
request.on('end', function() {
    var post = qs.parse(body);
    db.query('DELETE FROM topic WHERE id = ?', [post.id], function(error, result) {
        if(error) {
            throw error;
        }
        response.writeHead(302, {Location: `/`});
        response.end();
   });
});
```

## 2.9. JOIN을 이용한 상세 보기 구현
**topic**: 글의 제목, 설명, 작성시간, 작성자가 존재하는 테이블
**author**: 작성자의 id, 이름, 프로필이 존재하는 테이블 
➡️ `JOIN`을 이용하여 topic 테이블과 author 테이블을 하나로 합쳐서 표현하기
➡️ 작성자를 클릭하면 작성자 상세보기 기능을 구현
### 1) 글 상세 페이지에서 작성자 함께 표시
```javascript
else {
    db.query(`SELECT * FROM topic`, functi(error, topics) {
        if(error) {
            throw error;
        }
        // topic과 author 테이블을 topic의 author_id와 author의 id가 동일하게 조인
        db.query(`SELECT * FROM topic LEFT JOIN author ON topic.author_id=author.id WHERE topic.id=?`, [queryData.id], function(error2, topic) {
            if(error2) {
                throw error2;
            }
            var title = topic[0].title;
            var description = topic[0].description;
            var list = template.list(topics);
            var html = template.HTML(title, list,
                `<h2>${title}</h2>${description}<p>by ${topic[0].name}<p>`, // 사용자도 추가
    ...
}
```

## 2.10. 글 생성 구현
➡️ 글을 생성할 때 작성자를 선택할 수 있는 기능
### 1) 작성자 목록 가져오기
```javascript
else if(pathname === '/create') {
    db.query(`SELECT * FROM topic`, functio(error, topics) {
        // author 테이블 불러오기
        db.query('SELECT * FROM author', function(error2, authors) {
            var tag = '';
            var i = 0;
            // author_id의 개수만큼 콤보박스의 옵션 생성하기
            while(i < authors.length) {
                tag += `<option value="${authors[i].id}">${authors[i].name}</option>`;
                i++;
            }
            var title = 'Create';
            var list = template.list(topics);
            var html = template.HTML(title, list,
                `
                <form action="/create_process" method="post">
                    <p><input type="text" name="title" placeholder="title"></p>
                    <p>
                        <textarea name="description" placeholder="description"></textarea>
                    </p>
                    <p>
                        <select name="author">
                            ${tag}
                        </select>
                    </p>
                    <p>
                        <input type="submit">
                    </p>
                </form>
                `,
                `<a href="/create">create</a>`
            );
            response.writeHead(200);
            response.end(html);
        });
    });
}
```
### 2) 'author 개수만큼 콤보박스의 옵션 추가' 부분을 `templates.js`에 객체로 빼내기
```javascript
module.exports = {
    ...
    authorSelect:function(authors) {
        var tag = '';
        var i = 0;
        // author_id의 개수만큼 콤보박스의 옵션 생성하기
        while (i < authors.length) {
            tag += `<option value="${authors[i].id}">${authors[i].name}</option>`;
            i++;
        }
        return `
        <select name="author">
        ${tag}
        </select>`
    }
}
```
### 3) `main.js`에서 `authorSelect` 함수 호출
```javascript
...
var html = template.HTML(title, list,
    `
    <form action="/create_process" method="post">
        <p><input type="text" name="title" placeholder="title"></p>
        <p>
            <textarea name="description" placeholder="description"></textarea>
        </p>
        <p>
            ${template.authorSelect(authors)}
        </p>
        <p>
            <input type="submit">
        </p>
    </form>
    `,
    `<a href="/create">create</a>`
);
...
```
### 4) submit 버튼을 누를 때 작성자 정보도 함께 보내기
```javascript
else if(pathname === '/create_process') {
    var body = '';
    request.on('data', function(data) {
        body = body + data;
    });
    request.on('end', function() {
        var post = qs.parse(body);
        db.query(`
            INSERT INTO topic (title, description, created, author_id)
                VALUES(?, ?, NOW(), ?)`, // title, description, author 값을 추가하기
            [post.title, post.description, post.author], function(error, result) {
                if(error) {
                    throw error;
                }
                response.writeHead(302, {Location: `/?id=${result.insertId}`});
                response.end();
            }
        );
    });
```

## 2.11. 글 수정 구현
➡️ 글 수정 기능에서 글쓴이를 수정할 수 있게
### 1) author 선택 콤보박스 추가
```javascript
else if(pathname === '/update') {
    db.query('SELECT * FROM topic', function(error, topics) {
        if(error) {
            throw error;
        }
        db.query(`SELECT * FROM topic WHERE id=?`,[queryData.id], function(error2, topic) {
            if(error2) {
                throw error2;
            }
            // author 테이블의 모든 튜플들을 불러오기
            db.query('SELECT * FROM author', function(error2, authors) {
                var list = template.list(topics);
                var html = template.HTML(topic[0].title, list,
                    `
                    <form action="/update_process" method="post">
                        <input type="hidden" name="id" value="${topic[0].id}">
                        <p><input type="text" name="title" placeholder="title" value="${topic[0].title}"></p>
                        <p>
                            <textarea name="description" placeholder="description">${topic[0].description}</textarea>
                        </p>
                        <p>
                            ${template.authorSelect(authors)}
                        </p>
                        <p>
                            <input type="submit">
                        </p>
                    </form>
                    `,
                    `<a href="/create">create</a> <a href="/update?id=${topic[0].id}">update</a>`
                );
                response.writeHead(200);
                response.end(html);
            });
        });
    });
}
```
### 2) 현재 author 정보가 콤보박스의 첫 옵션으로 보여지도록
- `authorSelect` 함수의 두 번째 인자로 현재 author를 넘겨주도록
    ```javascript
    <p>
        ${template.authorSelect(authors, topic[0].author_id)}
    </p>
    ```
- `template.js`에서 두 번째 인자 관련하여 `authorSelect` 수정하기
    ```javascript
    authorSelect:function(authors, author_id) {
        var tag = '';
        var i = 0;
        // author_id의 개수만큼 콤보박스의 옵션 생성하기
        while(i < authors.length) {
            var selected = '';
            // author_id와 authors[i].id가 같으면 selected="selected" 추가
            if (authors[i].id === author_id){
                selected ='selected';
            }
            tag += `<option value="${authors[i].id}" ${selected}>${authors[i].name}</option>`;
            i++;
        }
        return `
            <select name="author">
                ${tag}
            </select>
        `
    }
    ```
### 3) 변경된 글쓴이 정보도 함께 저장되도록 `update_process` 수정
```javascript
else if(pathname === '/update_process') {
    var body = '';
    request.on('data', function(data) {
        body = body + data;
    });
    request.on('end', function() {
        var post = qs.parse(body);
        db.query('UPDATE topic SET title=?, description=?, author_id=? WHERE id=?',
            // title, description, author, id를 저장하도록
            [post.title, post.description, post.author, post.id], function(error, result) {
            response.writeHead(302, {Location: `/?id=${post.id}`});
            response.end();
        });
    });
}
```

## 2.13. Node.js의 DB 설정 정보 정리
➡️ `main.js` 파일의 코드가 너무 기니까, 기능별로 파일을 분리하여 정리하기
### 1) DB 접속코드를 `lib/db.js`로 분리하기
```javascript
var mysql = require('mysql');   // mysql 모듈 불러오기

// DB 커넥션 생성
var db = mysql.createConnection({
    host:'localhost',
    user:'root',
    password:'0731',
    database:'opentutorials'
});
db.connect();   // DB 연결

module.exports = db;
```
- 따로 모듈로 분리시키고, `main.js`에선 해당 내용 삭제하기

## 2.14. Node.js 코드 정리
➡️ 글 생성, 수정, 삭제 기능을 별도의 파일로 분리하기
### 1) 글 목록 보여주기 기능을 별도의 파일 `lib/topic.js`로 분리
```javascript
// lib/topic.js
var db = require('./db.js');
var template = require('./template.js');

// 함수를 정의와 동시에 exports
exports.home = function(request, response) {
    db.query(`SELECT * FROM topic`, function(error, topics) {
        var title = 'Welcome';
        var description = 'Hello, Node.js';
        var list = template.list(topics);   // topics 자체를 전달
        var html = template.HTML(title, list,
            `<h2>${title}</h2>${description}`,
            `<a href="/create">create</a>`
        );
        response.writeHead(200);
        response.end(html);
    });
}
```
```javascript
// main.js
...
var topic = require('./lib/topic.js'); // ./lib/topic.js (글 목록 불러오는 모듈) 불러오기

var app = http.createServer(function(request, response) {
    var _url = request.url;
    var queryData = url.parse(_url, true).query;
    var pathname = url.parse(_url, true).pathname;
    if(pathname === '/') {
        if(queryData.id === undefined) {
            topic.home(request, response);
...
```
### 2) 상세보기 페이지를 별도의 파일 `lib/topic.js`로 분리
```javascript
// lib/topic.js
exports.page = function(request, response) {
    var _url = request.url;
    var queryData = url.parse(_url, true).query;
    db.query(`SELECT * FROM topic`, function(error, topics) {
        if(error) {
            throw error;
        }
        // topic과 author 테이블을 topic의 author_id와 author의 id가 동일하게 조인
        db.query(`SELECT * FROM topic LEFT JOIN author ON topic.author_id=author.id WHERE topic.id=?`, [queryData.id], function(error2, topic) {
            if(error2) {
                throw error2;
            }
            var title = topic[0].title; // 타이틀을 topic 테이블의 title 컬럼으로
            var description = topic[0].description; // 설명을 topic 테이블의 description 컬럼으로
            var list = template.list(topics);
            var html = template.HTML(title, list,
                `<h2>${title}</h2>${description}<p>by ${topic[0].name}<p>`, // 사용자 추가
                ` <a href="/create">create</a>
                    <a href="/update?id=${queryData.id}">update</a>
                    <form action="delete_process" method="post">
                        <input type="hidden" name="id" value="${queryData.id}">
                        <input type="submit" value="delete">
                    </form>`
            );
            response.writeHead(200);
            response.end(html);
        });
    });
}
```
```javascript
// main.js
...
var app = http.createServer(function(request, response) {
    var _url = request.url;
    var queryData = url.parse(_url, true).query;
    var pathname = url.parse(_url, true).pathname;
    if(pathname === '/') {
        if(queryData.id === undefined) {
            topic.home(request, response);
        } else {
            topic.page(request, response);
        }
...
```
### 3) 글 생성 기능을 별도의 파일 `lib/topic.js`로 분리
```javascript
// lib/topic.js
exports.create = function(request, response) {
    db.query(`SELECT * FROM topic`, function(error, topics) {
        // author 테이블의 모든 튜플들을 불러오기
        db.query('SELECT * FROM author', function(error2, authors) {
            var title = 'Create';
            var list = template.list(topics);
            var html = template.HTML(title, list,
                `
                <form action="/create_process" method="post">
                    <p><input type="text" name="title" placeholder="title"></p>
                    <p>
                        <textarea name="description" placeholder="description"></textarea>
                    </p>
                    <p>
                        ${template.authorSelect(authors)}
                    </p>
                    <p>
                        <input type="submit">
                    </p>
                </form>
                `,
                `<a href="/create">create</a>`
            );
            response.writeHead(200);
            response.end(html);
        });
    });
}
```

```javascript
//main.js
else if(pathname === '/create') {
    topic.create(request, response);
}
```
### 4) 글 생성 처리 기능을 별도의 파일 `lib/topic.js`로 분리
```javascript
// lib/topic.js
exports.create_process = function(request, response) {
    var body = '';
        request.on('data', function(data) {
            body = body + data;
        });
        request.on('end', function() {
            var post = qs.parse(body);
            db.query(`
                INSERT INTO topic (title, description, created, author_id)
                    VALUES(?, ?, NOW(), ?)`, // title, description, author 값을 추가하기
                [post.title, post.description, post.author], function(error, result) {
                    if(error) {
                        throw error;
                    }
                    response.writeHead(302, {Location: `/?id=${result.insertId}`}); // 새로 추가한 데이터의 id값을 DB에서 가져오기
                    response.end();
                }
            );
        });
}
```

```javascript
// main.js
else if(pathname === '/create_process') {
        topic.create_process(request, response);
    }
```
### 4) 글 수정 기능을 별도의 파일 `lib/topic.js`로 분리
```javascript
// lib/topic.js
exports.update = function(request, response) {
    db.query('SELECT * FROM topic', function(error, topics) {
        if(error) {
            throw error;
        }
        db.query(`SELECT * FROM topic WHERE id=?`,[queryData.id], function(error2, topic) {
            if(error2) {
                throw error2;
            }
            // author 테이블의 모든 튜플들을 불러오기
            db.query('SELECT * FROM author', function(error2, authors) {
                var list = template.list(topics);
                var html = template.HTML(topic[0].title, list,
                    `
                    <form action="/update_process" method="post">
                        <input type="hidden" name="id" value="${topic[0].id}">
                        <p><input type="text" name="title" placeholder="title" value="${topic[0].title}"></p>
                        <p>
                            <textarea name="description" placeholder="description">${topic[0].description}</textarea>
                        </p>
                        <p>
                            ${template.authorSelect(authors, topic[0].author_id)}
                        </p>
                        <p>
                            <input type="submit">
                        </p>
                    </form>
                    `,
                    `<a href="/create">create</a> <a href="/update?id=${topic[0].id}">update</a>`
                );
                response.writeHead(200);
                response.end(html);
            });
        });
    });
}
```

```javascript
// main.js
else if(pathname === '/update') {
        topic.update(request, response);
    }
```
### 4) 글 수정 처리 기능을 별도의 파일 `lib/topic.js`로 분리
```javascript
// lib/topic.js
exports.update_process = function(request, response) {
    var body = '';
        request.on('data', function(data) {
            body = body + data;
        });
        request.on('end', function() {
            var post = qs.parse(body);
            db.query('UPDATE topic SET title=?, description=?, author_id=? WHERE id=?',
                // title, description, author, id를 저장하도록
                [post.title, post.description, post.author, post.id], function(error, result) {
                response.writeHead(302, {Location: `/?id=${post.id}`});
                response.end();
            });
        });
}
```

```javascript
// main.js
else if(pathname === '/update_process') {
        topic.update_process(request, response);
    }
```
### 5) 글 삭제 기능을 별도의 파일 `lib/topic.js`로 분리
```javascript
// lib/topic.js
exports.delete_process = function(request, response) {
    var body = '';
        request.on('data', function(data) {
            body = body + data;
        });
        request.on('end', function() {
            var post = qs.parse(body);
            db.query('DELETE FROM topic WHERE id = ?', [post.id], function(error, result) {
                if(error) {
                    throw error;
                }
                response.writeHead(302, {Location: `/`});
                response.end();
            });
        });
}
```

```javascript
// main.js
else if(pathname === '/delete_process') {
        topic.delete_process(request, response);
    }
```

## 2.16. 저자 목록 보기 기능 구현
➡️ 글 작성자 목록을 추가, 수정, 삭제 및 관리하기
### 1) `lib/template.js`에 저자 목록을 보여주는 author 링크 추가
```javascript
// lib/template.js
...
<body>
    <h1><a href="/">WEB</a></h1>
    <a href="/author">author</a>
    ${list}
    ${control}
    ${body}
</body>
...
```

### 2) author 링크를 클릭했을 때 `/author`경로를 처리하기
- `main.js`에서 `/author`경로에 따른 함수 작성
    ```javascript
    // main.js
    var author = require('./lib/author.js'); //./lib/author.js (작성자 목록 불러는 모듈) 불러오기   
    ...
    else if(pathname === '/author'){
            author.home(request, response);
        } 
        ...
    ```
    ➡️ `lib/author.js` 파일에서 `home` 함수를 정의하기
- `lib/author.js` 파일에서 `home` 함수 구현
    ```javascript
    // lib/author.js
    
    var db = require('./db');
    var template = require('./template.js');

    exports.home = function(request, response) {
        // author 테이블에서 모든 튜플을 불러옴
        db.query(`SELECT * FROM topic`, function(error, topics) {
            var title = 'Welcome';
            var description = 'Hello, Node.js';
            var list = template.list(topics);   // topics 자체를 전달
            var html = template.HTML(title, list,
                `
                <table>
                    <tr>
                        <td>egoing</td>
                        <td>developer</td>
                        <td>update</td>
                        <td>delete</td>
                    <tr>
                    <tr>
                        <td>egoing</td>
                        <td>developer</td>
                        <td>update</td>
                        <td>delete</td>
                    <tr>
                </table>
                <style>
                    table {
                        border-collapse: collapse;
                    }
                    td {
                        border: 1px solid black;
                    }
                </style>
                `,
                `<a href="/create">create</a>`
            );
            response.writeHead(200);
            response.end(html);
        });
    }
    ```
- author 테이블에서 테이블에 출력할 데이터 가져오기
    ```javascript
    // lib/author.js
        
    var db = require('./db');
    var template = require('./template.js');
    exports.home = function(request, response) {
        db.query(`SELECT * FROM topic`, function(error, topics) {
            // author 테이블의 모든 튜플들 불러오기
            db.query(`SELECT * FROM author`, function(error2, authors) {
                var tag = '<table>';
                var i = 0;
                // author의 수만큼 행을 추가
                while(i < authors.length) {
                    tag += `
                        <tr>
                            <td>${authors[i].name}</td>
                            <td>${authors[i].profile}</td>
                            <td>update</td>
                            <td>delete</td>
                        </tr>
                    `;
                    i++;
                }
                tag += '</table>';

                var title = 'author';
                var list = template.list(topics);
                var html = template.HTML(title, list,
                    `
                    ${tag}
                    <style>
                        table {
                            border-collapse: collapse;
                        }
                        td {
                            border: 1px solid black;
                        }
                    </style>
                    `,
                    `<a href="/create">create</a>`
                );
                response.writeHead(200);
                response.end(html);
            });
        });
    }
    ```
- `lib/author.js`에서 표를 출력하는 코드를 템플릿으로 분리
    ```javascript
    // lib/template.js

    authorTable:function(authors, author_id) {
        var tag = '<table>';
        var i = 0;
        // author의 수만큼 행을 추가
        while(i < authors.length) {
            tag += `
                <tr>
                    <td>${authors[i].name}</td>
                    <td>${authors[i].profile}</td>
                    <td>update</td>
                    <td>delete</td>
                </tr>
            `;
            i++;
        }
        tag += '</table>';
        return tag;
    }
    ```

    ```javascript
    // lib/author.js

    var html = template.HTML(title, list,
        `
        ${template.authorTable(authors)}   
        <style>
            table {
                border-collapse: collapse;
            }
            td {
                border: 1px solid black;
            }
        </style>
        `,
        `<a href="/create">create</a>`
    );
    ```

## 2.17. 저자 생성 기능 구현
### 1) 저자 추가를 위한 폼 생성
```javascript
// lib/author.js

exports.home = function(request, response) {
    db.query(`SELECT * FROM topic`, function(error, topics) {
        // author 테이블의 모든 튜플들 불러오기
        db.query(`SELECT * FROM author`, function(error2, authors) {
            var title = 'author';
            var list = template.list(topics);
            var html = template.HTML(title, list,
                `
                ${template.authorTable(authors)}
                <style>
                    table {
                        border-collapse: collapse;
                    }
                    td {
                        border: 1px solid black;
                    }
                </style>
                <form action="/author/create_process" method="post">
                    <p>
                        <input type="text" name="name" placeholder="name">
                    </p>
                    <p>
                        <textarea name="profile" placeholder="description"></textarea>
                    </p>
                    <p>
                        <input type="submit">
                    </p>
                </form>
                `,
                ``
            );
            response.writeHead(200);
            response.end(html);
        });
    });
}
```
### 2) `/author/create_process` 추가
```javascript
exports.create_process = function(request, response) {
    var body = '';
    request.on('data', function(data) {
        body = body + data;
    });
    request.on('end', function() {
        var post = qs.parse(body);
        db.query(`
            INSERT INTO author (name, profile)
                VALUES(?, ?)`,
            [post.name, post.profile],
            function(error, result) {
                if(error) {
                    throw error;
                }
                response.writeHead(302, {Location: `/author`});
                response.end();
            }
        );
    });
}
```

## 2.18. 저자 수정 기능 구현
### 1) 저자 정보 목록에 update 링크 추가
```javascript
// lib/template.js

while(i < authors.length) {
    tag += `
        <tr>
            <td>${authors[i].name}</td>
            <td>${authors[i].profile}</td>
            <td><a hred="/author/update?id=${authors[i].id}">update</a></td>
            <td>delete</td>
        </tr>
    `;
    i++;
}
```
### 2) update를 눌렀을 때 저자 정보가 담긴 폼을 보여지도록
```javascript
exports.update = function(request, response) {
    db.query(`SELECT * FROM topic`, function(error, topics) {
        db.query(`SELECT * FROM author`, function(error2, authors) {
            var _url = request.url;
            var queryData = url.parse(_url, true).query;
            db.query(`SELECT * FROM author WHERE id=?`, [queryData.id], function(error3, author) {
                var title = 'author';
                var list = template.list(topics);
                var html = template.HTML(title, list,
                    `
                    ${template.authorTable(authors)}
                    <style>
                        table {
                            border-collapse: collapse;
                        }
                        td {
                            border: 1px solid black;
                        }
                    </style>
                    <form action="/author/update_process" method="post">
                        <p>
                            <input type="hidden" name="id" value="${queryData.id}">
                        </p>
                        <p>
                            <input type="text" name="name" value="${author[0].name}" placeholder="name">
                        </p>
                        <p>
                            <textarea name="profile" placeholder="description">${author[0].profile}</textarea>
                        </p>
                        <p>
                            <input type="submit" value="update">
                        </p>
                    </form>
                    `,
                    ``
                );
                response.writeHead(200);
                response.end(html);
            });
        });
    });
}
```

### 3) 저자 수정 기능 (`update_process`) 구현
```javascript
exports.update_process = function(request, response) {
    var body = '';
    request.on('data', function(data) {
        body = body + data;
    });
    request.on('end', function() {
        var post = qs.parse(body);
        db.query(`
            UPDATE author SET name=?, profile=? WHERE id=?`,
            [post.name, post.profile, post.id],
            function(error, result) {
                if(error) {
                    throw error;
                }
                response.writeHead(302, {Location: `/author`});
                response.end();
            }
        );
    });
}
```

## 2.19. 저자 삭제 기능 구현
### 1) 저자 삭제 버튼 추가
```javascript
<td>
    <form action="/author/delete_process" method="post">
        <input type="hidden" name="id" value="${authors[i].id}">
        <input type="submit" value="delete">
    </form>
</td>
```
### 2) 저자 삭제 기능 구현
```javascript
exports.delete_process = function(request, response) {
    var body = '';
    request.on('data', function(data) {
        body = body + data;
    });
    request.on('end', function() {
        var post = qs.parse(body);
        // topic 테이블에서 id로 해당 튜플 삭제
        db.query(
            `DELETE FROM topic WHERE author_id=?`,
            [post.id],
            function(error1, result1) {
                if(error1) {
                    throw error1;
                }
                // author 테이블에서 id로 해당 튜플 삭제
                db.query(`
                    DELETE FROM author WHERE id=?`,
                    [post.id],
                    function(error, result) {
                        if(error) {
                            throw error;
                        }
                        response.writeHead(302, {Location: `/author`});
                        response.end();
                    }
                );
            }
        );
    });
}
```

## 2.20. 보안: SQL 인젝션
### 1) SQL 인젝션이란?
: 웹 애플리케이션의 사용자 입력값을 통해 데이터베이스에 SQL문을 주입해서 공격하는 기법
ex)
```javascript
db.query(`
    UPDATE author SET name=${post.name}, profile=${post.profile} WHERE id=${post.id}`,
    ...
);
```
- 해당 경우에, `post.id`가 `2; DROP TABLE topic;` 이라면 topic 테이블이 아예 삭제되어 버림
**_= SQL 인젝션이 발생하게 됨_**

### 2) SQL 인젝션 예방 방법 (1) - `?` 사용
```javascript
db.query(`
    UPDATE author SET name=?, profile=? WHERE id=?`,
    [post.name, post.profile, post.id],
    ...
);
```
- SQL문에 물음표로 지정한 후, 이후에 나오는 배열의 값들을 인수로 전달하는 방식으로 SQL 인젝션을 예방하기
- id=?에서 ?는 플레이스홀더라고 함
    - 플레이스홀더: SQL 쿼리에서 사용되는 특별한 기호로, 실행될 때 값이 대체되는 자리 표시자
    - [queryData.id]: 플레이스홀더 자리에 대체될 값을 제공하는 배열

### 3) SQL 인젝션 예방 방법 (2) - `escape()` 사용
```javascript
// db.js
...
var db = mysql.createConnection({
    host:'localhost',
    user:'root',
    password:'0731',
    database:'opentutorials',
    multipleStatements:true // 해당 설정 추가
});
...
```

```javascript
db.query(`
    UPDATE author SET name=${db.escape(post.name)}, profile=${db.escape(post.profile)} WHERE id=${db.escape(post.id)}`,
    ...
);
```
- db모듈의 escape 메서드를 이용하여 SQL 인젝션을 예방하기

## 2.21. 보안: 이스케이프
### 1) 사용자의 입력에 태그가 포함되어 있는 경우
ex) 
```javascript
<h2>${title}</h2>${description}
```
- 해당 경우에 description의 값이 문자가 아니라 `<h2>description</h2>`처럼 태그로 이루어져 있다면? 원치 않은 형태로 출력될 수가 있음
### 2) 예방 방법 - `sanitizeHtml` 사용
```javascript
var sanitizeHtml = require('sanitize-html');
...
exports.home = function(request, response) {
    ...
        var html = template.HTML(title, list,
            `<h2>${sanitizeHtml(title)}</h2>${sanitizeHtml(description)}`,
    ...
}
```
- 사용자가 입력하는 값 부분에 `sanitizeHtml`을 적용해 태그가 포함된 문자열을 필터링 함으로써 보안처리
- 저장된 정보를 사용자에게 출력할 때, 사용자를 공격할 수 있는 스크립트를 `sanitizeHtml` 라이브러리를 통해 막기
